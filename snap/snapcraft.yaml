name: pulseaudio-minimal
base: core24
version: '17.0'
summary: Minimal PulseAudio sound server for Ubuntu Core
description: |
  A minimal PulseAudio sound server snap for Ubuntu Core 24,
  built using Ubuntu packages. Provides audio-playback and
  audio-record interfaces for applications like Firefox.

grade: stable
confinement: strict
compression: lzo

platforms:
  arm64:
    build-on: [amd64]
    build-for: [arm64]

apps:
  pulseaudio:
    command: bin/pulseaudio
    daemon: simple
    install-mode: disable
    plugs:
      - alsa
      - network
      - network-bind
      - hardware-observe
    slots:
      - audio-playback
      - audio-record

  pactl:
    command-chain: [bin/client-wrapper]
    command: usr/bin/pactl
    plugs:
      - network
      - playback
      - record

plugs:
  playback:
    interface: audio-playback
  record:
    interface: audio-record

slots:
  audio-playback:
    interface: audio-playback
  audio-record:
    interface: audio-record

environment:
  LD_LIBRARY_PATH: "$SNAP/usr/lib/pulseaudio:$SNAP/usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR"
  PULSE_RUNTIME_PATH: /var/run/pulse
  PULSE_STATE_PATH: $SNAP_COMMON/state
  ALSA_CONFIG_PATH: $SNAP/usr/share/alsa/alsa.conf

layout:
  /etc/pulse:
    bind: $SNAP/etc/pulse
  /etc/alsa:
    bind: $SNAP/etc/alsa
  /var/lib/pulse:
    bind: $SNAP_DATA
  /usr/share/pulseaudio:
    symlink: $SNAP/usr/share/pulseaudio
  /usr/share/alsa:
    symlink: $SNAP/usr/share/alsa

parts:
  scripts:
    plugin: dump
    source: bin/
    organize:
      pulseaudio: bin/pulseaudio
      client-wrapper: bin/client-wrapper
    stage:
      - bin/pulseaudio
      - bin/client-wrapper

  config:
    plugin: dump
    source: config/
    organize:
      default.pa: etc/pulse/default.pa
      client.conf: etc/pulse/client.conf
    stage:
      - etc/pulse/default.pa
      - etc/pulse/client.conf

  pulseaudio:
    plugin: nil
    after: [scripts, config]
    stage-packages:
      # Core PulseAudio
      - pulseaudio
      - pulseaudio-utils
      - libpulse0
      - libpulse-mainloop-glib0
      # ALSA support
      - libasound2
      - libasound2-plugins
      - alsa-utils
      # Audio codecs
      - libsndfile1
      - libflac12
      - libogg0
      - libvorbis0a
      - libvorbisenc2
      - libopus0
      # Dependencies
      - libltdl7
      - libspeexdsp1
      - libasyncns0
      - libtdb1
      - libsoxr0
      - libdbus-1-3
      - libglib2.0-0
    override-build: |
      craftctl default
      # Create necessary directories
      mkdir -p $CRAFT_PART_INSTALL/var/run/pulse
      mkdir -p $CRAFT_PART_INSTALL/usr/share/applications
    stage:
      - usr/bin/pulseaudio
      - usr/bin/pactl
      - usr/bin/pacmd
      - usr/lib/*/libpulse*.so*
      - usr/lib/*/libasound*.so*
      - usr/lib/*/libsndfile*.so*
      - usr/lib/*/libFLAC*.so*
      - usr/lib/*/libogg*.so*
      - usr/lib/*/libvorbis*.so*
      - usr/lib/*/libopus*.so*
      - usr/lib/*/libltdl*.so*
      - usr/lib/*/libspeex*.so*
      - usr/lib/*/libasyncns*.so*
      - usr/lib/*/libtdb*.so*
      - usr/lib/*/libsoxr*.so*
      - usr/lib/*/libdbus*.so*
      - usr/lib/*/libglib*.so*
      - usr/lib/pulseaudio/*
      - usr/share/pulseaudio/*
      - usr/share/alsa/*
      - etc/alsa/*
      - var/run/pulse
      - usr/share/applications
